<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NFT Minter</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/react@18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios@1.6.7/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/babel-standalone@7.22.5/Babel.min.js"></script>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen">
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect } = React;

        function App() {
            const [prompt, setPrompt] = useState("");
            const [tonAddress, setTonAddress] = useState("");
            const [imageUrl, setImageUrl] = useState("");
            const [filename, setFilename] = useState("");
            const [message, setMessage] = useState("");
            const [loading, setLoading] = useState(false);
            const [ipfsImage, setIpfsImage] = useState("");
            const [ipfsMetadata, setIpfsMetadata] = useState("");
            const [nftUrl, setNftUrl] = useState("");

            const generateImage = async () => {
                setLoading(true);
                setMessage("");
                try {
                    const response = await axios.post("/generate-image", { prompt });
                    setImageUrl(`/image/${response.data.filename}`);
                    setFilename(response.data.filename);
                    setMessage(response.data.message);
                } catch (error) {
                    setMessage(`Error: ${error.response?.data?.detail || error.message}`);
                } finally {
                    setLoading(false);
                }
            };

            const uploadToIpfs = async () => {
                setLoading(true);
                setMessage("");
                try {
                    const response = await axios.post("/upload-to-ipfs", { prompt });
                    setIpfsImage(response.data.ipfs_image);
                    setIpfsMetadata(response.data.ipfs_metadata);
                    setFilename(response.data.filename);
                    setMessage("Image and metadata uploaded to IPFS");
                } catch (error) {
                    setMessage(`Error: ${error.response?.data?.detail || error.message}`);
                } finally {
                    setLoading(false);
                }
            };

            const mintNFT = async () => {
                if (!filename) {
                    setMessage("Please generate an image first");
                    return;
                }
                if (!tonAddress || !/^[0-9a-zA-Z_-]{48}$/.test(tonAddress)) {
                    setMessage("Please enter a valid TON address");
                    return;
                }
                setLoading(true);
                setMessage("");
                try {
                    const response = await axios.post("/mint-nft", { address: tonAddress, filename, prompt });
                    setMessage(response.data.message);
                    setNftUrl(response.data.url);
                    setIpfsImage(response.data.ipfs_image);
                    setIpfsMetadata(response.data.ipfs_metadata);
                } catch (error) {
                    setMessage(`Error: ${error.response?.data?.detail || error.message}`);
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="container mx-auto p-4 max-w-2xl bg-white rounded-lg shadow-lg">
                    <h1 className="text-3xl font-bold mb-4 text-center">NFT Minter</h1>
                    <p className="text-gray-600 mb-4 text-center">
                        Generate an image from a text prompt, upload it to IPFS, and mint it as an NFT on the TON blockchain.
                    </p>
                    <div className="mb-4">
                        <label className="block text-sm font-medium text-gray-700">Image Prompt</label>
                        <input
                            type="text"
                            value={prompt}
                            onChange={(e) => setPrompt(e.target.value)}
                            placeholder="e.g., owl in cyberpunk style"
                            className="mt-1 block w-full p-2 border rounded"
                        />
                    </div>
                    <button
                        onClick={generateImage}
                        disabled={loading || !prompt}
                        className="w-full bg-blue-500 text-white p-2 rounded hover:bg-blue-600 disabled:bg-gray-400 mb-4"
                    >
                        {loading ? "Generating..." : "Generate Image"}
                    </button>
                    {imageUrl && (
                        <div className="mb-4">
                            <img src={imageUrl} alt="Generated" className="w-full rounded" />
                            <button
                                onClick={uploadToIpfs}
                                disabled={loading}
                                className="w-full bg-green-500 text-white p-2 rounded hover:bg-green-600 disabled:bg-gray-400 mt-2"
                            >
                                {loading ? "Uploading..." : "Upload to IPFS"}
                            </button>
                        </div>
                    )}
                    {(ipfsImage || ipfsMetadata) && (
                        <div className="mb-4">
                            {ipfsImage && <p>IPFS Image: <a href={ipfsImage} target="_blank" className="text-blue-500">{ipfsImage}</a></p>}
                            {ipfsMetadata && <p>IPFS Metadata: <a href={ipfsMetadata} target="_blank" className="text-blue-500">{ipfsMetadata}</a></p>}
                        </div>
                    )}
                    <div className="mb-4">
                        <label className="block text-sm font-medium text-gray-700">TON Address</label>
                        <input
                            type="text"
                            value={tonAddress}
                            onChange={(e) => setTonAddress(e.target.value)}
                            placeholder="Enter TON address"
                            className="mt-1 block w-full p-2 border rounded"
                        />
                    </div>
                    <button
                        onClick={mintNFT}
                        disabled={loading || !tonAddress || !filename}
                        className="w-full bg-purple-500 text-white p-2 rounded hover:bg-purple-600 disabled:bg-gray-400"
                    >
                        {loading ? "Minting..." : "Mint NFT"}
                    </button>
                    {message && <p className="mt-4 text-center text-red-500">{message}</p>}
                    {nftUrl && (
                        <p className="mt-4 text-center">
                            NFT URL: <a href={nftUrl} target="_blank" className="text-blue-500">{nftUrl}</a>
                        </p>
                    )}
                </div>
            );
        }

        ReactDOM.render(<App />, document.getElementById("root"));
    </script>
</body>
</html>