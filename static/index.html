<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OKX-Style NFT Minter</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        'okx-blue': '#1E40AF',
                        'okx-purple': '#6B21A8',
                    },
                },
            },
        };
    </script>
    <script src="https://cdn.jsdelivr.net/npm/react@18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios@1.6.7/dist/axios.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone@7.22.5/babel.min.js"></script>
</head>
<body class="bg-gray-900 text-white flex items-center justify-center min-h-screen">
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useRef } = React;

        function App() {
            const [step1Expanded, setStep1Expanded] = useState(true);
            const [step2Expanded, setStep2Expanded] = useState(false);
            const [prompt, setPrompt] = useState("");
            const [editMode, setEditMode] = useState(false);
            const [tonAddress, setTonAddress] = useState("");
            const [imageUrl, setImageUrl] = useState("");
            const [filename, setFilename] = useState("");
            const [message, setMessage] = useState("");
            const [loading, setLoading] = useState(false);
            const [ipfsImage, setIpfsImage] = useState("");
            const [ipfsMetadata, setIpfsMetadata] = useState("");
            const [nftUrl, setNftUrl] = useState("");
            const fileInputRef = useRef(null);

            const generateImage = async () => {
                setLoading(true);
                setMessage("");
                try {
                    const response = await axios.post("/generate-image", { prompt });
                    const timestamp = Date.now();
                    setImageUrl(`/image/${response.data.filename}?t=${timestamp}`);
                    setFilename(response.data.filename);
                    setMessage(response.data.message);
                    setEditMode(false);
                    setStep1Expanded(true);
                    setStep2Expanded(true);
                } catch (error) {
                    setMessage(`Error: ${error.response?.data?.detail || error.message}`);
                } finally {
                    setLoading(false);
                }
            };

            const uploadImage = async (event) => {
                const file = event.target.files[0];
                if (!file) return;

                setLoading(true);
                setMessage("");
                try {
                    const formData = new FormData();
                    formData.append("file", file);
                    const response = await axios.post("/upload-image", formData, {
                        headers: { "Content-Type": "multipart/form-data" },
                    });
                    const timestamp = Date.now();
                    setImageUrl(`/image/${response.data.filename}?t=${timestamp}`);
                    setFilename(response.data.filename);
                    setMessage(response.data.message);
                    setPrompt(""); // Clear prompt for uploaded images
                    setStep1Expanded(true);
                    setStep2Expanded(true);
                } catch (error) {
                    setMessage(`Error: ${error.response?.data?.detail || error.message}`);
                } finally {
                    setLoading(false);
                    // Reset file input
                    if (fileInputRef.current) fileInputRef.current.value = "";
                }
            };

            const regenerateImage = () => {
                generateImage();
            };

            const editPrompt = () => {
                setEditMode(true);
            };

            const uploadToIpfs = async () => {
                setLoading(true);
                setMessage("");
                try {
                    const response = await axios.post("/upload-to-ipfs", prompt ? { prompt } : {});
                    setIpfsImage(response.data.ipfs_image);
                    setIpfsMetadata(response.data.ipfs_metadata);
                    setFilename(response.data.filename);
                    setMessage("Image and metadata uploaded to IPFS");
                } catch (error) {
                    setMessage(`Error: ${error.response?.data?.detail || error.message}`);
                } finally {
                    setLoading(false);
                }
            };

            const mintNFT = async () => {
                if (!filename) {
                    setMessage("Please generate or upload an image first");
                    return;
                }
                setLoading(true);
                setMessage("");
                try {
                    const response = await axios.post("/mint-nft", { address: tonAddress || null, filename, prompt: prompt || null });
                    setMessage(response.data.message);
                    setNftUrl(response.data.url);
                    setIpfsImage(response.data.ipfs_image);
                    setIpfsMetadata(response.data.ipfs_metadata);
                } catch (error) {
                    setMessage(`Error: ${error.response?.data?.detail || error.message}`);
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="container mx-auto p-6 max-w-3xl bg-gray-800 rounded-xl shadow-2xl">
                    <h1 className="text-4xl font-bold mb-6 text-center text-white">NFT Minter - Powered by TON Testnet</h1>
                    <p className="text-gray-300 mb-6 text-center">
                        Generate or upload an image, then mint it as an NFT on TON Testnet. Use a Testnet TON wallet address. If no address provided, NFT mints to default collection.
                    </p>

                    {/* Accordion Sections */}
                    <div className="space-y-4">
                        {/* Step 1: Generate or Upload Image & Upload to IPFS */}
                        <div className="bg-gray-700 rounded-lg">
                            <button
                                onClick={() => setStep1Expanded(!step1Expanded)}
                                className="w-full flex justify-between p-4 text-left text-xl font-semibold text-white hover:bg-gray-600 rounded-t-lg"
                            >
                                Step 1: Generate or Upload Image & Upload to IPFS
                                <span>{step1Expanded ? '-' : '+'}</span>
                            </button>
                            {step1Expanded && (
                                <div className="p-4">
                                    <p className="text-gray-400 mb-2">Enter a prompt to generate an NFT image (e.g., "owl in cyberpunk style") or upload your own image.</p>
                                    <div className="mb-4">
                                        <label className="block text-sm font-medium text-gray-300">Generate Image</label>
                                        <input
                                            type="text"
                                            value={prompt}
                                            onChange={(e) => setPrompt(e.target.value)}
                                            placeholder="Enter image prompt"
                                            className="mt-1 block w-full p-3 bg-gray-700 border border-gray-600 rounded text-white"
                                            disabled={!editMode && filename}
                                        />
                                        <button
                                            onClick={generateImage}
                                            disabled={loading || !prompt}
                                            className="w-full bg-gradient-to-r from-blue-600 to-purple-600 text-white p-3 rounded mt-4 hover:shadow-lg disabled:bg-gray-600"
                                        >
                                            {loading ? "Generating..." : editMode ? "Save & Generate" : "Generate Image"}
                                        </button>
                                    </div>
                                    <div className="mb-4">
                                        <label className="block text-sm font-medium text-gray-300">Upload Image</label>
                                        <input
                                            type="file"
                                            accept="image/png,image/jpeg"
                                            onChange={uploadImage}
                                            ref={fileInputRef}
                                            className="mt-1 block w-full p-3 bg-gray-700 border border-gray-600 rounded text-white"
                                            disabled={loading}
                                        />
                                        <p className="text-gray-400 text-sm mt-2">
                                            Recommended for NFT images: PNG or JPEG, max 5MB, 512x512 or higher resolution, clear and unique artwork. Square images work best for NFT platforms.
                                        </p>
                                    </div>
                                    {imageUrl && (
                                        <div className="mt-4">
                                            <img src={imageUrl} alt="Generated or Uploaded" className="w-full rounded" onError={() => setMessage("Failed to load image")} />
                                            <div className="flex mt-2">
                                                <button
                                                    onClick={editPrompt}
                                                    className="flex-1 bg-gray-700 text-white p-2 rounded mr-2 hover:bg-gray-600"
                                                >
                                                    Edit Prompt
                                                </button>
                                                <button
                                                    onClick={regenerateImage}
                                                    className="flex-1 bg-gray-700 text-white p-2 rounded hover:bg-gray-600"
                                                >
                                                    Regenerate
                                                </button>
                                            </div>
                                            <button
                                                onClick={uploadToIpfs}
                                                disabled={loading}
                                                className="w-full bg-gradient-to-r from-green-600 to-teal-600 text-white p-3 rounded mt-4 hover:shadow-lg disabled:bg-gray-600"
                                            >
                                                {loading ? "Uploading..." : "Upload to IPFS"}
                                            </button>
                                        </div>
                                    )}
                                </div>
                            )}
                        </div>

                        {/* Step 2: Enter TON Address & Mint NFT */}
                        <div className="bg-gray-700 rounded-lg">
                            <button
                                onClick={() => setStep2Expanded(!step2Expanded)}
                                className="w-full flex justify-between p-4 text-left text-xl font-semibold text-white hover:bg-gray-600 rounded-t-lg"
                            >
                                Step 2: Enter TON Address & Mint NFT
                                <span>{step2Expanded ? '-' : '+'}</span>
                            </button>
                            {step2Expanded && (
                                <div className="p-4">
                                    <p className="text-gray-400 mb-2">Enter your Testnet TON wallet address (optional). If left blank, NFT mints to default collection.</p>
                                    <input
                                        type="text"
                                        value={tonAddress}
                                        onChange={(e) => setTonAddress(e.target.value)}
                                        placeholder="Enter Testnet TON address (optional)"
                                        className="mt-1 block w-full p-3 bg-gray-700 border border-gray-600 rounded text-white"
                                    />
                                    <button
                                        onClick={mintNFT}
                                        disabled={loading || !filename}
                                        className="w-full bg-gradient-to-r from-blue-600 to-purple-600 text-white p-3 rounded mt-4 hover:shadow-lg disabled:bg-gray-600"
                                    >
                                        {loading ? "Minting..." : "Mint NFT"}
                                    </button>
                                </div>
                            )}
                        </div>
                    </div>

                    {/* Expand All Button */}
                    <button
                        onClick={() => {
                            setStep1Expanded(true);
                            setStep2Expanded(true);
                        }}
                        className="w-full bg-gray-700 text-white p-3 rounded mt-6 hover:bg-gray-600"
                    >
                        Expand All Steps
                    </button>

                    {/* Results */}
                    {message && <p className="mt-4 text-center text-red-400">{message}</p>}
                    {nftUrl && (
                        <p className="mt-4 text-center text-green-400">
                            NFT URL: <a href={nftUrl} target="_blank" className="text-blue-400 underline">{nftUrl}</a>
                        </p>
                    )}
                    {(ipfsImage || ipfsMetadata) && (
                        <div className="mt-4 text-center text-gray-300">
                            {ipfsImage && <p>IPFS Image: <a href={ipfsImage} target="_blank" className="text-blue-400 underline">{ipfsImage}</a></p>}
                            {ipfsMetadata && <p>IPFS Metadata: <a href={ipfsMetadata} target="_blank" className="text-blue-400 underline">{ipfsMetadata}</a></p>}
                        </div>
                    )}
                </div>
            );
        }

        ReactDOM.render(<App />, document.getElementById("root"));
    </script>
</body>
</html>